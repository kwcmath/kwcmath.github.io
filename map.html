<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交通費里程計算</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* API Key 設定區域 */
        .api-setup {
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
        }

        .api-setup h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .api-setup p {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
        }

        .api-input-group {
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .api-input-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            font-family: 'Courier New', monospace;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .api-tutorial {
            background: rgba(255, 255, 255, 0.8);
            padding: 25px;
            border-radius: 15px;
            margin: 30px auto;
            max-width: 700px;
            text-align: left;
            border-left: 4px solid #4facfe;
        }

        .api-tutorial h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .api-tutorial ol {
            color: #555;
            line-height: 1.8;
            padding-left: 20px;
        }

        .api-tutorial li {
            margin-bottom: 8px;
        }

        .api-tutorial a {
            color: #4facfe;
            text-decoration: none;
            font-weight: 600;
        }

        .api-tutorial a:hover {
            text-decoration: underline;
        }

        /* 主要應用區域 */
        .content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            padding: 30px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .cost-calculation-panel {
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        .controls {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        .api-status {
            background: linear-gradient(45deg, #00b894 0%, #00cec9 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .input-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            cursor: pointer;
        }

        .input-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
        }

        .radio-option:hover {
            border-color: #4facfe;
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.1);
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 50%;
            margin-right: 12px;
            position: relative;
            transition: all 0.3s ease;
        }

        .radio-option input[type="radio"]:checked+.radio-custom {
            border-color: #4facfe;
            background: #4facfe;
        }

        .radio-option input[type="radio"]:checked+.radio-custom::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
        }

        .radio-option input[type="radio"]:checked~.radio-text {
            color: #4facfe;
            font-weight: 600;
        }

        .radio-text {
            font-size: 16px;
            color: #333;
            transition: all 0.3s ease;
        }

        .btn {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
            width: calc(60% - 10px);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
        }

        .btn-api {
            width: auto;
            padding: 15px 40px;
            font-size: 18px;
        }

        .btn-clear {
            background: linear-gradient(45deg, #ff7675 0%, #fd79a8 100%);
            box-shadow: 0 4px 15px rgba(255, 118, 117, 0.3);
        }

        .btn-print {
            background: linear-gradient(45deg, #6c5ce7 0%, #a29bfe 100%);
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            width: 100%;
            margin: 10px 0;
        }

        .btn-clear:hover {
            box-shadow: 0 8px 20px rgba(255, 118, 117, 0.4);
        }

        .btn-print {
            background: linear-gradient(45deg, #6c5ce7 0%, #a29bfe 100%);
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            width: 100%;
            margin: 10px 0;
        }

        .btn-print:hover {
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
        }

        .print-header {
            display: none;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }

        .print-header h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
            font-weight: bold;
        }

        /* 列印時顯示標題 */
        @media print {
            .print-header {
                display: block !important;
            }
        }

        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                background: white !important;
                margin: 0;
                padding: 20px;
                font-family: Arial, sans-serif;
            }

            .no-print {
                display: none !important;
            }

            .right-panel {
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                gap: 20px !important;
            }

            .map-container {
                height: 400px !important;
                width: 100% !important;
                margin-bottom: 20px !important;
                border: 2px solid #333 !important;
                page-break-inside: avoid;
            }

            .route-info {
                background: white !important;
                border: 2px solid #333 !important;
                margin: 10px 0 !important;
                page-break-inside: avoid;
            }

            .route-info h3 {
                color: #333 !important;
                font-size: 16px !important;
                font-weight: bold !important;
                border-bottom: 1px solid #333 !important;
                padding-bottom: 8px !important;
            }

            .btn-route-select {
                display: none !important;
            }

            .route-details {
                display: flex !important;
                gap: 15px !important;
            }

            .route-stat {
                background: #f8f9fa !important;
                border: 1px solid #333 !important;
                padding: 10px !important;
                text-align: center !important;
                flex: 1 !important;
            }

            .route-stat .label {
                font-size: 12px !important;
                color: #333 !important;
                font-weight: bold !important;
                margin-bottom: 5px !important;
            }

            .route-stat .value {
                font-size: 14px !important;
                font-weight: bold !important;
                color: #333 !important;
            }

            .cost-calculation-panel {
                background: white !important;
                border: 2px solid #333 !important;
                margin-top: 20px !important;
                page-break-inside: avoid;
            }

            .route-comparison {
                background: #f0f0f0 !important;
                border: none !important;
                margin: 0 !important;
            }

            .route-comparison h3 {
                color: #333 !important;
                font-size: 18px !important;
                font-weight: bold !important;
                margin-bottom: 15px !important;
            }

            .cost-calculation {
                background: white !important;
            }

            .cost-selector label {
                color: #333 !important;
                font-weight: bold !important;
            }

            .radio-option {
                border: 1px solid #333 !important;
                background: white !important;
            }

            .radio-option input[type="radio"]:checked~.radio-text {
                color: #333 !important;
                font-weight: bold !important;
            }

            .cost-breakdown {
                margin-top: 15px !important;
            }

            .cost-item {
                background: white !important;
                border: 1px solid #333 !important;
                color: #333 !important;
                margin-bottom: 8px !important;
                padding: 10px !important;
            }

            .cost-item.total-cost {
                background: #f0f0f0 !important;
                border: 2px solid #333 !important;
                font-weight: bold !important;
                font-size: 16px !important;
            }

            .cost-label,
            .cost-value {
                color: #333 !important;
            }

            /* 隱藏不需要的元素 */
            .container>.header,
            .content>.controls {
                display: none !important;
            }

            .content {
                display: block !important;
                padding: 0 !important;
            }
        }

        .btn-change-api {
            background: linear-gradient(45deg, #fdcb6e 0%, #e17055 100%);
            box-shadow: 0 4px 15px rgba(253, 203, 110, 0.3);
            width: 100%;
            margin: 0 0 20px 0;
        }

        .btn-change-api:hover {
            box-shadow: 0 8px 20px rgba(253, 203, 110, 0.4);
        }

        .route-info {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #4facfe;
        }

        .route-info h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-route-select {
            background: linear-gradient(45deg, #00b894 0%, #00cec9 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .btn-route-select:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 184, 148, 0.4);
        }

        .btn-route-select.active {
            background: linear-gradient(45deg, #fd79a8 0%, #fdcb6e 100%);
            box-shadow: 0 4px 12px rgba(253, 121, 168, 0.4);
        }

        .route-comparison {
            background: linear-gradient(135deg, #a8e6cf 0%, #88d8a3 100%);
            padding: 20px;
            border-radius: 15px;
            color: #2d3436;
            margin: 0;
        }

        .route-comparison-stats {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            color: #2d3436;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        .right-panel #routeInfo {
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            padding: 0;
            margin: 0;
        }

        .right-panel .route-info {
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            border-left: none;
            border-bottom: 1px solid #e1e5e9;
        }

        .right-panel .route-info:last-child {
            border-bottom: none;
            border-radius: 0 0 15px 15px;
        }

        .right-panel .route-info:first-child {
            border-radius: 15px 15px 0 0;
        }

        .route-comparison h3,
        .route-comparison-stats h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #2d3436;
        }

        .cost-calculation {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .cost-selector {
            margin-bottom: 20px;
        }

        .cost-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3436;
        }

        .cost-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3436;
        }

        .cost-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cost-selector select:focus {
            outline: none;
            border-color: #88d8a3;
            box-shadow: 0 0 0 3px rgba(136, 216, 163, 0.1);
        }

        .cost-selector select:hover {
            border-color: #88d8a3;
        }

        .cost-breakdown {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
        }

        .cost-item.total-cost {
            background: linear-gradient(45deg, #fd79a8 0%, #fdcb6e 100%);
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }

        .cost-label {
            font-weight: 600;
        }

        .cost-value {
            font-weight: bold;
        }

        .trip-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }

        .trip-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px 0;
        }

        .trip-detail:last-child {
            margin-bottom: 0;
        }

        .trip-label {
            font-weight: 600;
            color: #2d3436;
            font-size: 16px;
        }

        .trip-value {
            font-weight: bold;
            color: #2d3436;
            font-size: 16px;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }

        .comparison-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .comparison-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .comparison-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #666;
        }

        .comparison-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3436;
        }

        .route-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .route-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .route-stat .label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .route-stat .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .map-container {
            background: #fff;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            height: 300px;
            flex-shrink: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 16px;
        }

        .loading.show {
            display: block;
        }

        .error {
            background: #ff7675;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #00b894;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }

        .success.show {
            display: block;
        }

        .map-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #f8f9fa;
            color: #666;
            font-size: 18px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .route-details {
                grid-template-columns: 1fr;
            }

            @media (max-width: 768px) {
                .content {
                    grid-template-columns: 1fr;
                }

                .header h1 {
                    font-size: 2em;
                }

                .route-details {
                    grid-template-columns: 1fr;
                }

                .btn {
                    width: 100%;
                    margin: 5px 0;
                }

                .comparison-stats {
                    grid-template-columns: 1fr;
                }

                .route-info h3 {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 10px;
                }

                .btn-route-select {
                    margin-left: 0;
                    align-self: flex-start;
                }

                .radio-group {
                    gap: 8px;
                }

                .radio-text {
                    font-size: 14px;
                }

                .map-container {
                    height: 250px;
                }
            }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🚗 交通費里程計算</h1>
            <p>選擇交通工具，計算路線及交通費用</p>
        </div>

        <!-- API Key 設定頁面 -->
        <div class="api-setup" id="apiSetup">
            <h2>🔑 請輸入 Google Maps API Key</h2>
            <p>為了使用交通費里程計算功能，您需要提供一個有效的 Google Maps API Key</p>

            <div class="api-input-group">
                <input type="text" id="apiKeyInput" placeholder="請輸入您的 Google Maps API Key">
            </div>

            <button class="btn btn-api" onclick="validateAndSetApiKey()">🚀 開始使用</button>

            <div class="error" id="apiError"></div>
            <div class="success" id="apiSuccess"></div>

            <div class="api-tutorial">
                <h3>📚 如何獲取 Google Maps API Key？</h3>
                <ol>
                    <li>前往 <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></li>
                    <li>建立新專案或選擇現有專案</li>
                    <li>啟用以下 API 服務：
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Maps JavaScript API</li>
                            <li>Directions API</li>
                            <li>Places API</li>
                        </ul>
                    </li>
                    <li>在「憑證」頁面建立 API Key</li>
                    <li>複製 API Key 並貼到上方輸入框</li>
                </ol>
                <p style="margin-top: 15px; font-size: 14px; color: #888;">
                    💡 建議：測試階段可以不設限制，正式使用時請設定適當的 API Key 限制
                </p>
            </div>
        </div>

        <!-- 主要應用頁面 -->
        <div class="content hidden" id="mainApp">
            <div class="controls">
                <div class="api-status">
                    ✅ API Key 已設定完成
                </div>

                <button class="btn btn-change-api" onclick="changeApiKey()">🔄 更換 API Key</button>

                <div class="input-group">
                    <label>🚗 交通工具</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="travelMode" value="car" checked onchange="updateTravelMode()">
                            <span class="radio-custom"></span>
                            <span class="radio-text">🚗 開車 (每公里 NT$ 3)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="travelMode" value="motorcycle" onchange="updateTravelMode()">
                            <span class="radio-custom"></span>
                            <span class="radio-text">🏍️ 機車 (每公里 NT$ 2)</span>
                        </label>
                    </div>
                </div>

                <div class="input-group">
                    <label for="origin">🚩 出發地點</label>
                    <input type="text" id="origin" placeholder="請輸入出發地點">
                </div>

                <div class="input-group">
                    <label for="destination">🏁 到達地點</label>
                    <input type="text" id="destination" placeholder="請輸入到達地點">
                </div>

                <button class="btn" onclick="showRoutes()">🔍 顯示路線</button>
                <button class="btn btn-clear" onclick="clearRoute()">🗑️ 清除</button>
                <button class="btn btn-print" onclick="printRoute()" id="printBtn" style="display: none;">🖨️
                    列印</button>

                <div class="loading" id="loading">
                    <p>⏳ 正在規劃最佳及最短路線...</p>
                </div>

                <div class="error" id="error"></div>

                <div id="routeInfo" style="display: none;">
                    <div class="route-info">
                        <h3 style="color: #333; margin-bottom: 15px; display: flex; align-items: center;">
                            🛣️ 最佳路線 (時間優先)
                            <button class="btn-route-select" onclick="showBestRoute()" id="bestRouteBtn">顯示此路線</button>
                        </h3>
                        <div class="route-details">
                            <div class="route-stat">
                                <div class="label">距離</div>
                                <div class="value" id="bestDistance">-</div>
                            </div>
                            <div class="route-stat">
                                <div class="label">時間</div>
                                <div class="value" id="bestDuration">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="route-info">
                        <h3 style="color: #333; margin-bottom: 15px; display: flex; align-items: center;">
                            📍 最短路線 (距離優先)
                            <button class="btn-route-select" onclick="showShortestRoute()"
                                id="shortestRouteBtn">顯示此路線</button>
                        </h3>
                        <div class="route-details">
                            <div class="route-stat">
                                <div class="label">距離</div>
                                <div class="value" id="shortestDistance">-</div>
                            </div>
                            <div class="route-stat">
                                <div class="label">時間</div>
                                <div class="value" id="shortestDuration">-</div>
                            </div>
                        </div>
                    </div>


                    <div class="route-comparison-stats" style="display: none;">
                        <h3>📊 路線比較</h3>
                        <div class="comparison-stats">
                            <div class="comparison-item">
                                <span class="comparison-label">距離差異：</span>
                                <span class="comparison-value" id="distanceDiff">-</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">時間差異：</span>
                                <span class="comparison-value" id="timeDiff">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="map-container">
                    <div id="map">
                        <div class="map-placeholder">
                            <div>
                                <div style="font-size: 3em; margin-bottom: 20px;">🗺️</div>
                                <div>請輸入出發地點和到達地點</div>
                                <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">然後點擊「顯示路線」按鈕</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="cost-calculation-panel" id="costPanel" style="display: none;">
                    <div class="route-comparison">
                        <h3>💰 交通費計算</h3>
                        <div class="cost-calculation">
                            <div class="trip-info">
                                <div class="trip-detail">
                                    <span class="trip-label">出發地點：</span>
                                    <span class="trip-value" id="tripOrigin">-</span>
                                </div>
                                <div class="trip-detail">
                                    <span class="trip-label">到達地點：</span>
                                    <span class="trip-value" id="tripDestination">-</span>
                                </div>
                            </div>
                            <div class="cost-breakdown" id="costBreakdown">
                                <div class="cost-item">
                                    <span class="cost-label">選擇路線：</span>
                                    <span class="cost-value" id="selectedRouteInfo">-</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">計算方式：</span>
                                    <span class="cost-value" id="costFormula">-</span>
                                </div>
                                <div class="cost-item total-cost">
                                    <span class="cost-label">來回總費用：</span>
                                    <span class="cost-value" id="totalCost">NT$ 0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 列印標題（只在列印時顯示） -->
        <div class="print-header" style="display: none;">
            <h1>交通費路線圖</h1>
            <div id="printHeaderDate"></div>
        </div>
    </div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let isMapInitialized = false;
        let currentApiKey = '';
        let bestRoute = null;
        let shortestRoute = null;
        let currentDisplayedRoute = 'best';
        let currentTravelMode = 'car'; // 'car' or 'motorcycle'

        // 驗證並設定 API Key
        function validateAndSetApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();

            if (!apiKey) {
                showApiError('請輸入 API Key');
                return;
            }

            if (apiKey.length < 30) {
                showApiError('API Key 格式似乎不正確，請檢查是否完整複製');
                return;
            }

            // 顯示載入中
            showApiMessage('🔄 正在驗證 API Key...', 'loading');

            // 測試 API Key 是否有效
            testApiKey(apiKey);
        }

        // 測試 API Key
        function testApiKey(apiKey) {
            currentApiKey = apiKey;

            // 動態載入 Google Maps API
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=onApiLoaded&libraries=places&language=zh-TW`;
            script.async = true;
            script.defer = true;

            // 錯誤處理
            script.onerror = function () {
                showApiError('API Key 無效或網路連線有問題');
            };

            document.head.appendChild(script);
        }

        // API 載入完成回調
        window.onApiLoaded = function () {
            try {
                // 嘗試創建一個簡單的地圖來測試 API
                const testMap = new google.maps.Map(document.createElement('div'), {
                    zoom: 10,
                    center: { lat: 25.0330, lng: 121.5654 }
                });

                // 如果能成功創建地圖，表示 API Key 有效
                showApiSuccess('✅ API Key 驗證成功！正在進入應用...');

                setTimeout(() => {
                    switchToMainApp();
                }, 1500);

            } catch (error) {
                showApiError('API Key 驗證失敗：' + error.message);
            }
        };

        // 切換到主應用
        function switchToMainApp() {
            document.getElementById('apiSetup').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        // 更換 API Key
        function changeApiKey() {
            // 重置狀態
            isMapInitialized = false;
            currentApiKey = '';

            // 重置API設定頁面的選項
            currentTravelMode = 'car';

            // 重置交通工具選擇
            if (document.querySelector('input[name="travelMode"][value="car"]')) {
                document.querySelector('input[name="travelMode"][value="car"]').checked = true;
            }

            // 清除地圖
            if (map) {
                map = null;
            }

            // 重置 UI
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('origin').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('routeInfo').style.display = 'none';
            document.getElementById('costPanel').style.display = 'none';
            document.getElementById('printBtn').style.display = 'none';
            document.getElementById('map').innerHTML = '<div class="map-placeholder"><div><div style="font-size: 3em; margin-bottom: 20px;">🗺️</div><div>請輸入出發地點和到達地點</div><div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">然後點擊「顯示路線」按鈕</div></div></div>';

            // 切換回 API 設定頁面
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('apiSetup').classList.remove('hidden');

            hideApiMessages();
        }

        // 更新交通工具
        function updateTravelMode() {
            const selectedRadio = document.querySelector('input[name="travelMode"]:checked');
            currentTravelMode = selectedRadio.value;

            // 如果已經有路線，重新計算費用
            if (bestRoute && shortestRoute) {
                calculateTransportCost();
            }
        }

        // 顯示路線
        async function showRoutes() {
            const origin = document.getElementById('origin').value.trim();
            const destination = document.getElementById('destination').value.trim();

            if (!origin || !destination) {
                showError('請輸入出發地點和到達地點');
                return;
            }

            showLoading(true);
            hideError();

            try {
                // 初始化地圖（如果還沒初始化）
                if (!isMapInitialized) {
                    await initializeMap();
                }

                // 同時規劃最佳路線和最短路線
                await Promise.all([
                    calculateBestRoute(origin, destination),
                    calculateShortestRoute(origin, destination)
                ]);

                // 更新UI顯示
                updateRouteDisplay();
                calculateRouteDifferences();
                calculateTransportCost(); // 計算交通費用

                // 顯示交通費計算面板和列印按鈕
                document.getElementById('costPanel').style.display = 'block';
                document.getElementById('printBtn').style.display = 'block';

                // 預設顯示最短路線
                showShortestRoute();

                showLoading(false);

            } catch (error) {
                showLoading(false);
                showError('載入路線時發生錯誤：' + error.message);
                console.error('路線規劃錯誤:', error);
            }
        }

        // 計算最佳路線（時間優先）
        function calculateBestRoute(origin, destination) {
            return new Promise((resolve, reject) => {
                // 根據交通工具設定路線模式
                const travelMode = currentTravelMode === 'motorcycle' ?
                    google.maps.TravelMode.TWO_WHEELER :
                    google.maps.TravelMode.DRIVING;

                const request = {
                    origin: origin,
                    destination: destination,
                    travelMode: travelMode,
                    unitSystem: google.maps.UnitSystem.METRIC,
                    region: 'TW',
                    provideRouteAlternatives: false,
                    optimizeWaypoints: false,
                    avoidHighways: false,
                    avoidTolls: false
                };

                directionsService.route(request, function (result, status) {
                    if (status === 'OK') {
                        bestRoute = result;
                        resolve(result);
                    } else {
                        reject(new Error('最佳路線規劃失敗: ' + status));
                    }
                });
            });
        }

        // 計算最短路線（距離優先）
        function calculateShortestRoute(origin, destination) {
            return new Promise((resolve, reject) => {
                // 根據交通工具設定路線模式
                const travelMode = currentTravelMode === 'motorcycle' ?
                    google.maps.TravelMode.TWO_WHEELER :
                    google.maps.TravelMode.DRIVING;

                const request = {
                    origin: origin,
                    destination: destination,
                    travelMode: travelMode,
                    unitSystem: google.maps.UnitSystem.METRIC,
                    region: 'TW',
                    provideRouteAlternatives: true, // 獲取多條路線
                    optimizeWaypoints: true,
                    avoidHighways: false,
                    avoidTolls: false
                };

                directionsService.route(request, function (result, status) {
                    if (status === 'OK') {
                        // 從多條路線中選擇距離最短的
                        let shortestRouteResult = result;
                        if (result.routes.length > 1) {
                            let minDistance = result.routes[0].legs[0].distance.value;
                            let shortestIndex = 0;

                            for (let i = 1; i < result.routes.length; i++) {
                                const distance = result.routes[i].legs[0].distance.value;
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    shortestIndex = i;
                                }
                            }

                            // 創建只包含最短路線的結果
                            shortestRouteResult = {
                                ...result,
                                routes: [result.routes[shortestIndex]]
                            };
                        }

                        shortestRoute = shortestRouteResult;
                        resolve(shortestRouteResult);
                    } else {
                        reject(new Error('最短路線規劃失敗: ' + status));
                    }
                });
            });
        }

        // 更新路線資訊顯示
        function updateRouteDisplay() {
            if (!bestRoute || !shortestRoute) return;

            // 最佳路線資訊
            const bestLeg = bestRoute.routes[0].legs[0];
            document.getElementById('bestDistance').textContent = bestLeg.distance.text;
            document.getElementById('bestDuration').textContent = bestLeg.duration.text;

            // 最短路線資訊
            const shortestLeg = shortestRoute.routes[0].legs[0];
            document.getElementById('shortestDistance').textContent = shortestLeg.distance.text;
            document.getElementById('shortestDuration').textContent = shortestLeg.duration.text;

            // 顯示路線資訊區域
            document.getElementById('routeInfo').style.display = 'block';
        }

        // 計算路線差異
        function calculateRouteDifferences() {
            if (!bestRoute || !shortestRoute) return;

            const bestLeg = bestRoute.routes[0].legs[0];
            const shortestLeg = shortestRoute.routes[0].legs[0];

            // 計算距離差異
            const distanceDiff = Math.abs(bestLeg.distance.value - shortestLeg.distance.value);
            const distanceDiffKm = (distanceDiff / 1000).toFixed(1);

            // 計算時間差異
            const timeDiff = Math.abs(bestLeg.duration.value - shortestLeg.duration.value);
            const timeDiffMin = Math.round(timeDiff / 60);

            // 更新顯示
            document.getElementById('distanceDiff').textContent = `${distanceDiffKm} 公里`;
            document.getElementById('timeDiff').textContent = `${timeDiffMin} 分鐘`;
        }

        // 顯示最佳路線
        function showBestRoute() {
            if (!bestRoute) return;

            directionsRenderer.setDirections(bestRoute);
            currentDisplayedRoute = 'best';

            // 更新按鈕狀態
            document.getElementById('bestRouteBtn').classList.add('active');
            document.getElementById('shortestRouteBtn').classList.remove('active');

            // 自動計算交通費用
            calculateTransportCost();
        }

        // 顯示最短路線
        function showShortestRoute() {
            if (!shortestRoute) return;

            directionsRenderer.setDirections(shortestRoute);
            currentDisplayedRoute = 'shortest';

            // 更新按鈕狀態
            document.getElementById('shortestRouteBtn').classList.add('active');
            document.getElementById('bestRouteBtn').classList.remove('active');

            // 自動計算交通費用
            calculateTransportCost();
        }

        // 計算交通費用
        function calculateTransportCost() {
            if (!bestRoute || !shortestRoute) return;

            // 根據當前顯示的路線進行計算
            const selectedRoute = currentDisplayedRoute === 'best' ? bestRoute : shortestRoute;
            const selectedLeg = selectedRoute.routes[0].legs[0];

            // 獲取距離（公里）
            const distanceInKm = selectedLeg.distance.value / 1000;

            // 根據交通工具設定每公里費用
            const ratePerKm = currentTravelMode === 'car' ? 3 : 2;
            const vehicleText = currentTravelMode === 'car' ? '開車' : '機車';

            // 計算來回費用（距離 × 2 × 每公里費用）
            const totalCost = Math.round(distanceInKm * 2 * ratePerKm);

            // 更新顯示
            document.getElementById('selectedRouteInfo').textContent =
                `${currentDisplayedRoute === 'best' ? '最佳路線' : '最短路線'} (${selectedLeg.distance.text})`;

            document.getElementById('costFormula').textContent =
                `${distanceInKm.toFixed(1)} km × 2 (來回) × NT$ ${ratePerKm} (${vehicleText})`;

            document.getElementById('totalCost').textContent = `NT$ ${totalCost.toLocaleString()}`;

            // 更新出發地點和到達地點
            document.getElementById('tripOrigin').textContent = document.getElementById('origin').value || '-';
            document.getElementById('tripDestination').textContent = document.getElementById('destination').value || '-';
        }

        // 列印功能
        function printRoute() {
            if (!bestRoute || !shortestRoute) {
                showError('請先規劃路線才能列印');
                return;
            }

            // 設定列印日期
            document.getElementById('printHeaderDate').textContent =
                `列印日期：${new Date().toLocaleDateString('zh-TW')} ${new Date().toLocaleTimeString('zh-TW')}`;

            // 為左側控制面板添加 no-print class
            document.querySelector('.controls').classList.add('no-print');

            // 將標題插入到 body 的最前面（列印時）
            const printHeader = document.querySelector('.print-header');
            document.body.insertBefore(printHeader, document.body.firstChild);

            // 執行列印
            setTimeout(() => {
                window.print();

                // 列印完成後恢復
                setTimeout(() => {
                    document.querySelector('.controls').classList.remove('no-print');
                    // 將標題移回原位
                    document.querySelector('.container').appendChild(printHeader);
                }, 500);
            }, 100);
        }

        // 初始化地圖
        function initializeMap() {
            return new Promise((resolve, reject) => {
                try {
                    // 清除佔位符
                    document.getElementById('map').innerHTML = '';

                    // 創建地圖
                    map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 13,
                        center: { lat: 25.0330, lng: 121.5654 },
                        styles: [
                            {
                                featureType: "water",
                                elementType: "geometry",
                                stylers: [{ color: "#e9e9e9" }, { lightness: 17 }]
                            },
                            {
                                featureType: "landscape",
                                elementType: "geometry",
                                stylers: [{ color: "#f5f5f5" }, { lightness: 20 }]
                            }
                        ]
                    });

                    // 創建路線服務
                    directionsService = new google.maps.DirectionsService();
                    directionsRenderer = new google.maps.DirectionsRenderer({
                        draggable: false,
                        suppressMarkers: false
                    });
                    directionsRenderer.setMap(map);

                    isMapInitialized = true;
                    resolve();

                } catch (error) {
                    reject(error);
                }
            });
        }

        // 清除路線
        function clearRoute() {
            document.getElementById('origin').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('routeInfo').style.display = 'none';
            document.getElementById('costPanel').style.display = 'none';
            document.getElementById('printBtn').style.display = 'none';

            // 重置路線資料
            bestRoute = null;
            shortestRoute = null;
            currentDisplayedRoute = 'shortest';
            currentTravelMode = 'car';

            // 重置交通工具選擇
            document.querySelector('input[name="travelMode"][value="car"]').checked = true;

            // 重置按鈕狀態
            document.getElementById('bestRouteBtn').classList.remove('active');
            document.getElementById('shortestRouteBtn').classList.remove('active');

            if (directionsRenderer) {
                directionsRenderer.setDirections({ routes: [] });
            }

            if (map) {
                map.setCenter({ lat: 25.0330, lng: 121.5654 });
                map.setZoom(13);
            }

            hideError();
        }

        // API 訊息顯示函數
        function showApiError(message) {
            hideApiMessages();
            const error = document.getElementById('apiError');
            error.textContent = message;
            error.classList.add('show');
        }

        function showApiSuccess(message) {
            hideApiMessages();
            const success = document.getElementById('apiSuccess');
            success.textContent = message;
            success.classList.add('show');
        }

        function showApiMessage(message, type) {
            hideApiMessages();
            if (type === 'loading') {
                const success = document.getElementById('apiSuccess');
                success.textContent = message;
                success.classList.add('show');
            }
        }

        function hideApiMessages() {
            document.getElementById('apiError').classList.remove('show');
            document.getElementById('apiSuccess').classList.remove('show');
        }

        // 其他工具函數
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.classList.add('show');
        }

        function hideError() {
            const error = document.getElementById('error');
            error.classList.remove('show');
        }

        // Enter鍵處理
        document.addEventListener('DOMContentLoaded', function () {
            // API Key 輸入框
            document.getElementById('apiKeyInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') validateAndSetApiKey();
            });
        });

        // 延遲載入主應用的事件監聽器
        function setupMainAppEventListeners() {
            document.getElementById('origin').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') showRoutes();
            });

            document.getElementById('destination').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') showRoutes();
            });
        }

        // 當切換到主應用時設定事件監聽器
        const originalSwitchToMainApp = switchToMainApp;
        switchToMainApp = function () {
            originalSwitchToMainApp();
            setTimeout(setupMainAppEventListeners, 100);
        };
    </script>
</body>

</html>